<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alta Pro - Bank Grade Editor</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Courier Prime is used to mimic “Bank Courier” -->
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

  <!-- PDF.js / PDF-Lib (compatible versions) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    :root {
      --bg-app: #f1f5f9;
      --bg-panel: #ffffff;
      --accent: #cceeff;
      --accent-dark: #99d1f2;
      --accent-active: #0066cc;
      --text: #334155;
      --border: #cbd5e1;
    }
    * { box-sizing: border-box; user-select: none; }
    body {
      margin: 0; font-family: 'Inter', sans-serif;
      background: var(--bg-app); color: var(--text);
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* Ribbon */
    .ribbon {
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      height: 100px;
      display: flex; align-items: stretch;
      padding: 0 12px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      z-index: 50; gap: 4px;
    }
    .brand-section {
      display: flex; flex-direction: column; justify-content: center;
      padding-right: 16px; margin-right: 8px;
      border-right: 1px solid var(--border);
      color: #0f172a; font-weight: 800; font-size: 18px; letter-spacing: -0.5px;
    }
    .tool-group {
      display: flex; align-items: center; gap: 4px; padding: 6px 4px;
      position: relative;
    }
    .tool-group::after {
      content: ''; position: absolute; right: 0; top: 15px; bottom: 15px;
      width: 1px; background: var(--border);
    }
    .tool-group:last-child::after { display: none; }

    .btn-large {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 100%; min-width: 55px; padding: 0 8px;
      background: transparent; border: 1px solid transparent; border-radius: 6px;
      color: #64748b; cursor: pointer; transition: all 0.1s;
      gap: 6px;
    }
    .btn-large i { font-size: 20px; margin-bottom: 2px; }
    .btn-large span { font-size: 11px; font-weight: 600; }
    .btn-large:hover { background: #f8fafc; color: var(--accent-active); }
    .btn-large.active {
      background: var(--accent); border-color: var(--accent-dark); color: var(--accent-active);
    }
    .btn-large:disabled { opacity: 0.5; cursor: not-allowed; }

    .action-col { display: flex; flex-direction: column; justify-content: center; gap: 4px; height: 100%; }
    .action-row { display: flex; gap: 2px; }
    .btn-icon {
      width: 28px; height: 28px;
      border: 1px solid transparent; background: transparent; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: #475569; transition: all .12s;
    }
    .btn-icon:hover { background: #f1f5f9; border-color: var(--border); }
    .btn-icon.active { background: var(--accent); border-color: var(--accent-dark); color: var(--accent-active); }
    .btn-icon i { font-size: 13px; }

    select, input[type=number] {
      height: 28px; border: 1px solid var(--border); border-radius: 4px;
      font-size: 12px; padding-left: 6px; color: #334155;
    }
    select { width: 130px; }
    input[type=number] { width: 50px; }
    input[type=color] {
      width: 28px; height: 28px; padding: 0; border: none; cursor: pointer;
    }

    /* Workspace */
    #workspace {
      flex: 1; background: #475569;
      overflow: auto; display: flex; justify-content: center; padding: 40px; position: relative;
    }
    #canvas-container {
      position: relative; background: white;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 8px 10px -6px rgba(0,0,0,0.5);
    }
    canvas { position: absolute; top: 0; left: 0; }
    #pdf-layer { z-index: 1; }
    #ui-layer { z-index: 10; cursor: crosshair; }

    /* Inline editor */
    #inline-editor {
      position: absolute; z-index: 100;
      background: transparent; padding: 0; margin: 0;
      border: 1px dashed #0066cc; outline: none;
      resize: none; overflow: hidden; white-space: pre;
      line-height: 1.15; display: none; transform-origin: top left;
    }

    /* Upload overlay */
    #upload-overlay {
      position: fixed; inset: 0; z-index: 999;
      background: rgba(255,255,255,0.95);
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
    }
    #upload-overlay.hidden { display: none; }
    .big-upload-btn {
      padding: 16px 32px; font-size: 16px; font-weight: 700;
      color: var(--accent-active); background: var(--accent);
      border: 2px solid var(--accent-dark); border-radius: 8px; cursor: pointer; transition: transform 0.1s;
    }
    .big-upload-btn:hover { transform: scale(1.02); }

  </style>
</head>
<body>

  <div class="ribbon">
    <div class="brand-section">
      <i class="fa-solid fa-layer-group" style="color:var(--accent-active); margin-bottom:4px;"></i>
      ALTA
    </div>

    <!-- Group 1: File -->
    <div class="tool-group">
      <button class="btn-large" id="btn-open"><i class="fa-regular fa-folder-open"></i><span>Open</span></button>
      <button class="btn-large" id="btn-save" disabled><i class="fa-regular fa-floppy-disk"></i><span>Save</span></button>
      <button class="btn-large" id="btn-print"><i class="fa-solid fa-print"></i><span>Print</span></button>
    </div>

    <!-- Group 2: Edit -->
    <div class="tool-group">
      <div class="action-col">
        <div class="action-row">
          <button class="btn-icon" id="btn-undo" title="Undo"><i class="fa-solid fa-rotate-left"></i></button>
          <button class="btn-icon" id="btn-redo" title="Redo"><i class="fa-solid fa-rotate-right"></i></button>
          <button class="btn-icon" id="btn-delete" title="Delete"><i class="fa-solid fa-trash" style="color:#ef4444;"></i></button>
        </div>
      </div>
    </div>

    <!-- Group 3: Tools -->
    <div class="tool-group">
      <button class="btn-large active" data-tool="select"><i class="fa-solid fa-arrow-pointer"></i><span>Select</span></button>
      <button class="btn-large" data-tool="text"><i class="fa-solid fa-font"></i><span>Text</span></button>
      <button class="btn-large" data-tool="whiteout"><i class="fa-solid fa-eraser"></i><span>Erase</span></button>
      <button class="btn-large" data-tool="image"><i class="fa-regular fa-image"></i><span>Image</span></button>
    </div>

    <!-- Group 4: Formatting -->
    <div class="tool-group">
      <div class="action-col">
        <div class="action-row">
          <select id="font-family">
            <option value="BankCourier">Bank Courier</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times">Times Roman</option>
          </select>
          <input type="number" id="font-size" value="12" min="6" max="96">
        </div>
        <div class="action-row">
          <button class="btn-icon" id="btn-bold" title="Bold / Darkness"><i class="fa-solid fa-bold"></i></button>
          <input type="color" id="font-color" value="#000000">
          <button class="btn-icon" id="align-left" title="Align Left"><i class="fa-solid fa-align-left"></i></button>
          <button class="btn-icon" id="align-center" title="Align Center"><i class="fa-solid fa-align-center"></i></button>
          <button class="btn-icon" id="align-right" title="Align Right"><i class="fa-solid fa-align-right"></i></button>
        </div>
      </div>
    </div>

    <!-- Group 5: View -->
    <div class="tool-group" style="margin-left:auto;">
      <button class="btn-icon" id="zoom-out"><i class="fa-solid fa-minus"></i></button>
      <span style="font-size:12px; min-width:48px; text-align:center;" id="zoom-val">100%</span>
      <button class="btn-icon" id="zoom-in"><i class="fa-solid fa-plus"></i></button>
    </div>
  </div>

  <!-- Workspace -->
  <div id="workspace">
    <div id="canvas-container">
      <canvas id="pdf-layer"></canvas>
      <canvas id="ui-layer"></canvas>
      <textarea id="inline-editor"></textarea>
    </div>
  </div>

  <!-- Upload Overlay -->
  <div id="upload-overlay">
    <i class="fa-solid fa-cloud-arrow-up fa-4x" style="color:#cbd5e1;"></i>
    <h2 style="margin:6px 0 0 0;">Upload PDF Document</h2>
    <button class="big-upload-btn" onclick="document.getElementById('file-in').click()">Browse Files</button>
  </div>

  <!-- Hidden Inputs -->
  <input type="file" id="file-in" accept="application/pdf" style="display:none">
  <input type="file" id="img-in" accept="image/*" style="display:none">

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const S = {
  pdf: null, doc: null, bytes: null, page: 1, scale: 1.2,
  tool: 'select', objs: [], sel: null,
  isEdit: false, drag: null, resize: null,
  history: [], hi: -1
};

// DOM
const wrap = document.getElementById('canvas-container');
const pdfC = document.getElementById('pdf-layer');
const uiC  = document.getElementById('ui-layer');
const pctx = pdfC.getContext('2d');
const uctx = uiC.getContext('2d');
const editor = document.getElementById('inline-editor');

// Controls
const fontSel = document.getElementById('font-family');
const sizeInp = document.getElementById('font-size');
const colorInp= document.getElementById('font-color');
const boldBtn = document.getElementById('btn-bold');

// Init
window.onload = () => {
  document.getElementById('file-in').onchange = e=>{ if(e.target.files[0]) openPDF(e.target.files[0]); };
  document.getElementById('btn-open').onclick = ()=>document.getElementById('file-in').click();
  document.getElementById('btn-save').onclick = savePDF;
  document.getElementById('btn-print').onclick = ()=>window.print();
  document.getElementById('img-in').onchange = e=>loadImg(e.target.files[0]);

  document.querySelectorAll('[data-tool]').forEach(b=>b.onclick=()=>setTool(b.dataset.tool));
  document.getElementById('btn-undo').onclick = undo;
  document.getElementById('btn-redo').onclick = redo;
  document.getElementById('btn-delete').onclick = delSel;
  document.getElementById('zoom-in').onclick = ()=>{S.scale=Math.min(3,S.scale+0.1); render();};
  document.getElementById('zoom-out').onclick= ()=>{S.scale=Math.max(0.5,S.scale-0.1); render();};

  [fontSel,sizeInp,colorInp].forEach(el=>el.oninput=applyProps);
  boldBtn.onclick = ()=>{boldBtn.classList.toggle('active'); applyProps();};

  ['left','center','right'].forEach(a=>{
    document.getElementById('align-'+a).onclick=()=>{
      if(S.sel){ const o=getSel(); if(o&&o.type==='text'){ o.align=a; renderUI(); saveState(); }}
    };
  });

  uiC.onmousedown = onDown;
  uiC.onmousemove = onMove;
  window.onmouseup = onUp;
  uiC.ondblclick = onDbl;

  editor.onblur = commitEdit;
  editor.onkeydown = e=>{
    if(e.key==='Enter'&& !e.shiftKey){ e.preventDefault(); commitEdit(); }
    if(e.key==='Escape'){ cancelEdit(); }
  };

  // Drag-drop overlay
  ['dragenter','dragover'].forEach(ev=>document.addEventListener(ev,e=>{e.preventDefault(); document.getElementById('upload-overlay').classList.remove('hidden');}));
  ['dragleave','drop'].forEach(ev=>document.addEventListener(ev,e=>{e.preventDefault(); if(ev==='drop'){if(e.dataTransfer.files[0]) openPDF(e.dataTransfer.files[0]);} document.getElementById('upload-overlay').classList.add('hidden');}));
};

function setTool(t){
  S.tool=t;
  document.querySelectorAll('.btn-large').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  uiC.style.cursor = t==='select' ? 'default' : 'crosshair';
  if(t!=='select'){ S.sel=null; renderUI(); }
}

async function openPDF(file){
  S.bytes = await file.arrayBuffer();
  S.pdf   = await pdfjsLib.getDocument({data:S.bytes}).promise;
  S.doc   = await PDFLib.PDFDocument.load(S.bytes);
  S.page  = 1; S.objs=[]; S.sel=null;
  document.getElementById('btn-save').disabled=false;
  document.getElementById('upload-overlay').classList.add('hidden');
  render(); saveState();
}

async function render(){
  if(!S.pdf) return;
  const page = await S.pdf.getPage(S.page);
  const vp = page.getViewport({scale:S.scale});
  [pdfC,uiC].forEach(c=>{ c.width=vp.width; c.height=vp.height;});
  wrap.style.width = vp.width+'px'; wrap.style.height=vp.height+'px';
  await page.render({canvasContext:pctx, viewport:vp}).promise;
  document.getElementById('zoom-val').innerText = Math.round(S.scale*100)+'%';
  renderUI();
}

function renderUI(){
  uctx.clearRect(0,0,uiC.width,uiC.height);
  for(const o of S.objs){
    if(S.isEdit && S.sel===o.id) continue;
    const x=o.x*S.scale, y=o.y*S.scale, w=o.w*S.scale, h=o.h*S.scale;
    if(o.type==='whiteout'){
      uctx.fillStyle='#fff'; uctx.fillRect(x,y,w,h);
    } else if(o.type==='image' && o.img){
      uctx.drawImage(o.img,x,y,w,h);
    } else if(o.type==='text'){
      uctx.save();
      const fam = o.font==='BankCourier' ? '"Courier Prime", Courier, monospace' : (o.font==='Times'?'Times New Roman, serif':'Helvetica, Arial, sans-serif');
      const weight = o.bold ? '700' : '400';
      uctx.font = `${weight} ${o.size*S.scale}px ${fam}`;
      uctx.fillStyle = o.color;
      uctx.textBaseline='top';
      let tx = x;
      const tw = uctx.measureText(o.text).width;
      if(o.align==='center') tx = x + (w - tw)/2;
      if(o.align==='right')  tx = x + w - tw;
      uctx.fillText(o.text, tx, y);
      uctx.restore();
    }
  }
  if(S.sel && !S.isEdit){
    const o=getSel(); if(!o) return;
    const x=o.x*S.scale,y=o.y*S.scale,w=o.w*S.scale,h=o.h*S.scale;
    uctx.save();
    uctx.strokeStyle='#0066cc'; uctx.lineWidth=1.5; uctx.setLineDash([4,2]);
    uctx.strokeRect(x,y,w,h);
    uctx.setLineDash([]);
    uctx.fillStyle='#cceeff';
    const pts=[[x,y],[x+w,y],[x,y+h],[x+w,y+h]];
    for(const [hx,hy] of pts){ uctx.fillRect(hx-4,hy-4,8,8); uctx.strokeRect(hx-4,hy-4,8,8); }
    uctx.restore();
  }
}

function getPos(e){
  const r=uiC.getBoundingClientRect();
  return {x:(e.clientX-r.left)/S.scale, y:(e.clientY-r.top)/S.scale};
}
function hitObj(x,y){
  for(let i=S.objs.length-1;i>=0;i--){
    const o=S.objs[i];
    if(x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h) return o;
  }
  return null;
}
function handleHit(o,x,y){
  const tol=6;
  const pts=[
    {n:'nw',x:o.x,y:o.y},
    {n:'ne',x:o.x+o.w,y:o.y},
    {n:'sw',x:o.x,y:o.y+o.h},
    {n:'se',x:o.x+o.w,y:o.y+o.h},
  ];
  for(const p of pts){ if(Math.abs(x-p.x)<=tol && Math.abs(y-p.y)<=tol) return p.n; }
  return null;
}
function onDown(e){
  const {x,y}=getPos(e);
  if(S.tool==='select'){
    const hit = hitObj(x,y);
    if(hit){
      S.sel=hit.id;
      const h=handleHit(hit,x,y);
      if(h){ S.resize=h; }
      else { S.drag={dx:x-hit.x, dy:y-hit.y}; }
      syncUI(hit);
    } else { S.sel=null; }
    renderUI();
  } else if(S.tool==='text'){
    createTextAt(x,y);
  } else if(S.tool==='whiteout'){
    S.drag={start:{x,y}, white:true};
  } else if(S.tool==='image'){
    document.getElementById('img-in').click();
  }
}
function onMove(e){
  const {x,y}=getPos(e);
  if(S.drag && S.drag.white){
    renderUI();
    const sx=S.drag.start.x*S.scale, sy=S.drag.start.y*S.scale;
    const w=x*S.scale - sx, h=y*S.scale - sy;
    uctx.fillStyle='rgba(204,238,255,0.35)';
    uctx.strokeStyle='#0066cc';
    uctx.fillRect(sx,sy,w,h); uctx.strokeRect(sx,sy,w,h);
  }
  if(S.drag && !S.drag.white && S.sel){
    const o=getSel();
    o.x = x - S.drag.dx; o.y = y - S.drag.dy;
    if(o.maskId){ const m=S.objs.find(i=>i.id===o.maskId); if(m){ m.x=o.x; m.y=o.y; } }
    renderUI();
  }
  if(S.resize && S.sel){
    const o=getSel();
    resizeObj(o,S.resize,x,y);
    if(o.maskId){ const m=S.objs.find(i=>i.id===o.maskId); if(m){ m.x=o.x; m.y=o.y; m.w=o.w; m.h=o.h; } }
    renderUI();
  }
}
function onUp(e){
  if(S.drag && S.drag.white){
    const {x,y}=getPos(e);
    const sx=S.drag.start.x, sy=S.drag.start.y;
    S.objs.push({id:genId(), type:'whiteout', x:Math.min(x,sx), y:Math.min(y,sy), w:Math.abs(x-sx), h:Math.abs(y-sy)});
    saveState(); renderUI();
  }
  if(S.drag && !S.drag.white && S.sel) saveState();
  S.drag=null; S.resize=null;
}
function onDbl(e){
  const {x,y}=getPos(e);
  const o = S.objs.find(o=>o.type==='text' && x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h);
  if(o){ S.sel=o.id; startEdit(o); }
  else if(S.tool==='select'){ // dblclick empty to add text + mask
    createTextAt(x,y);
  }
}

function resizeObj(o,h,x,y){
  const min=8;
  if(h==='nw'){ const nx=Math.min(o.x+o.w-min,x); const ny=Math.min(o.y+o.h-min,y); o.w=o.x+o.w-nx; o.h=o.y+o.h-ny; o.x=nx; o.y=ny; }
  if(h==='ne'){ const ny=Math.min(o.y+o.h-min,y); o.w=Math.max(min,x-o.x); o.h=o.y+o.h-ny; o.y=ny; }
  if(h==='sw'){ const nx=Math.min(o.x+o.w-min,x); o.w=o.x+o.w-nx; o.h=Math.max(min,y-o.y); o.x=nx; }
  if(h==='se'){ o.w=Math.max(min,x-o.x); o.h=Math.max(min,y-o.y); }
}

function createTextAt(x,y){
  // Auto-mask behind text
  const maskId = genId();
  const txtId  = genId();
  const size   = parseInt(sizeInp.value)||12;
  const h      = size*1.2;
  const w      = 160;
  S.objs.push({id:maskId,type:'whiteout',x,y,w,h});
  S.objs.push({
    id:txtId,type:'text',text:'',
    x,y,w,h,
    font:fontSel.value||'BankCourier',
    size, color:colorInp.value||'#000',
    bold:boldBtn.classList.contains('active'),
    align:'left',
    maskId
  });
  S.sel=txtId; setTool('select'); saveState(); startEdit(getSel());
}

function startEdit(o){
  S.isEdit=true;
  editor.style.display='block';
  editor.style.left=(o.x*S.scale)+'px';
  editor.style.top =(o.y*S.scale)+'px';
  editor.style.width =(o.w*S.scale)+'px';
  editor.style.height=(o.h*S.scale)+'px';
  editor.style.fontFamily = o.font==='BankCourier' ? '"Courier Prime", Courier, monospace' : (o.font==='Times'?'Times New Roman, serif':'Helvetica, Arial, sans-serif');
  editor.style.fontSize = (o.size*S.scale)+'px';
  editor.style.fontWeight = o.bold ? '700' : '400';
  editor.style.color = o.color;
  editor.style.textAlign = o.align||'left';
  editor.value = o.text;
  editor.focus();
  renderUI();
}

function commitEdit(){
  if(!S.isEdit) return;
  const o=getSel(); if(!o) return;
  o.text = editor.value;
  uctx.font = `${o.bold?'bold ':''}${o.size}px ${o.font==='BankCourier'?'Courier Prime':'Helvetica'}`;
  const tw = uctx.measureText(o.text).width + 10;
  o.w = Math.max(40, tw);
  o.h = o.size*1.2;
  if(o.maskId){ const m=S.objs.find(i=>i.id===o.maskId); if(m){ m.x=o.x; m.y=o.y; m.w=o.w; m.h=o.h; } }
  S.isEdit=false; editor.style.display='none'; saveState(); renderUI();
}
function cancelEdit(){ S.isEdit=false; editor.style.display='none'; renderUI(); }

function applyProps(){
  const o=getSel(); if(!o||o.type!=='text') return;
  o.font = fontSel.value;
  o.size = parseInt(sizeInp.value)||o.size;
  o.color= colorInp.value;
  o.bold = boldBtn.classList.contains('active');
  saveState(); renderUI();
}

function getSel(){ return S.objs.find(o=>o.id===S.sel); }
function genId(){ return crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2); }

function undo(){
  if(S.hi>0){ S.hi--; S.objs=JSON.parse(S.history[S.hi]); renderUI(); }
}
function redo(){
  if(S.hi<S.history.length-1){ S.hi++; S.objs=JSON.parse(S.history[S.hi]); renderUI(); }
}
function saveState(){
  if(S.hi < S.history.length-1) S.history = S.history.slice(0,S.hi+1);
  S.history.push(JSON.stringify(S.objs));
  S.hi++;
}

function delSel(){
  if(!S.sel) return;
  const o=getSel();
  if(o && o.maskId) S.objs = S.objs.filter(x=>x.id!==o.maskId);
  S.objs = S.objs.filter(x=>x.id!==S.sel);
  S.sel=null; saveState(); renderUI();
}

function loadImg(file){
  if(!file) return;
  const img=new Image();
  img.onload=()=>{
    const ratio=img.height/img.width;
    const w=200, h=200*ratio;
    S.objs.push({id:genId(),type:'image',img,x:40,y:40,w,h});
    saveState(); renderUI();
  };
  img.src=URL.createObjectURL(file);
}

// Save with pdf-lib
async function savePDF(){
  if(!S.doc) return;
  const doc = await PDFLib.PDFDocument.load(S.bytes);
  const page = doc.getPages()[S.page-1];
  const {height} = page.getSize();

  const fontCache={};
  async function getFont(f,b){
    const key=f+(b?'b':'n'); if(fontCache[key]) return fontCache[key];
    let name;
    if(f==='BankCourier') name = b?PDFLib.StandardFonts.CourierBold:PDFLib.StandardFonts.Courier;
    else if(f==='Times')   name = b?PDFLib.StandardFonts.TimesRomanBold:PDFLib.StandardFonts.TimesRoman;
    else                   name = b?PDFLib.StandardFonts.HelveticaBold:PDFLib.StandardFonts.Helvetica;
    const ft = await doc.embedFont(name); fontCache[key]=ft; return ft;
  }

  for(const o of S.objs){
    if(o.type==='whiteout'){
      page.drawRectangle({x:o.x, y:height - (o.y+o.h), width:o.w, height:o.h, color: PDFLib.rgb(1,1,1)});
    } else if(o.type==='text'){
      const font = await getFont(o.font, o.bold);
      const rgb = hexToRgb(o.color||'#000000');
      const size = o.size;
      const y = height - o.y - size*0.8;
      const tw = font.widthOfTextAtSize(o.text, size);
      let tx = o.x;
      if(o.align==='center') tx = o.x + (o.w - tw)/2;
      if(o.align==='right')  tx = o.x + o.w - tw;
      page.drawText(o.text,{
        x:tx, y,
        size,
        font,
        color: PDFLib.rgb(rgb.r/255,rgb.g/255,rgb.b/255)
      });
    } else if(o.type==='image' && o.img){
      // embed via canvas to png
      const c=document.createElement('canvas');
      c.width=o.img.naturalWidth; c.height=o.img.naturalHeight;
      c.getContext('2d').drawImage(o.img,0,0);
      const dataUrl = c.toDataURL('image/png');
      const embed = await doc.embedPng(dataUrl);
      page.drawImage(embed,{x:o.x, y:height - (o.y+o.h), width:o.w, height:o.h});
    }
  }
  const bytes = await doc.save();
  const blob = new Blob([bytes], {type:'application/pdf'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='edited.pdf'; a.click();
  URL.revokeObjectURL(a.href);
}

function hexToRgb(hex){
  const v=parseInt(hex.slice(1),16);
  return {r:(v>>16)&255,g:(v>>8)&255,b:v&255};
}
</script>
</body>
</html>
